generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(ulid())
  firstName        String
  lastName         String
  email            String           @unique
  phone            String?          @unique
  password         String?
  userRole         UserRole         @default(user)
  requestedRole    UserRole?
  assignedArea     String?
  approval         ApprovalStatus   @default(pending)
  status           AccountStatus    @default(active)
  verificationCode String?
  isVerified       Boolean          @default(false)
  createdAt        DateTime         @default(now())
  sessions         Session[]
  member           Member? //* User can become a member or not
  updatedAt        DateTime         @updatedAt
  photo            String?
  preferences      UserPreference[]
  membersApproved  MemberApproval[]
  tasks            Task[] // submitted

  // approvals this user RECEIVED
  approvalsReceived      StaffApproval[]  @relation("approved_received")
  // approvals this user GAVE
  approvalsGiven         StaffApproval[]  @relation("approver_given")
  transactedBy           Transaction[]    @relation("transactedBy")
  monthlyExpenseApproved MonthlyExpense[]
  disbursementsApproved  Disbursement[]

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(ulid())
  sessionId    String   @db.Text
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  deviceId     String?
  deviceInfo   String?
  ipAddress    String?
  location     String?
  compositeKey String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("user_sessions")
}

model Contribution {
  id                 String            @id @default(ulid())
  amount             Decimal           @db.Decimal(10, 2)
  member             Member            @relation(references: [id], fields: [memberId], onDelete: Cascade)
  memberId           String
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  transactions       Transaction[]
  projectId          String?
  caseId             String?
  contributionTypeId String
  contributionType   ContributionType? @relation(fields: [contributionTypeId], references: [id], onDelete: Cascade)

  @@map("contributions")
}

model ContributionType {
  id             String                         @id @default(ulid())
  name           String                         @unique
  category       ContributionTypeCategory
  defaultAmount  Decimal                        @default(0) @db.Decimal(10, 2)
  status         ContributionTypeCategoryStatus @default(pending)
  description    String?                        @db.Text
  contributions  Contribution[]
  contributionId String
  createdAt      DateTime                       @default(now())
  updatedAt      DateTime                       @updatedAt

  @@map("contribution_types")
}

model Transaction {
  id                String             @id @default(ulid())
  transactionMethod TransactionMenthod // cash | mpesa
  transactionType   TransactionType // contribution | disbursement(payout) | expenditure
  amount            Decimal            @db.Decimal(10, 2)
  transactionStatus TransactionStatus  @default(pending) // pending | completed
  member            Member             @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId          String
  transactedById    String?
  transactedBy      User?              @relation("transactedBy", fields: [transactedById], references: [id], onDelete: SetNull)
  contribution      Contribution?      @relation(fields: [contributionId], references: [id], onDelete: Cascade)
  contributionId    String?
  disbursementId    String?
  disbursement      Disbursement?      @relation(fields: [disbursementId], references: [id], onDelete: Cascade)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  mpesaTransaction  MpesaTransaction?
  monthlyExpense    MonthlyExpense?    @relation(fields: [monthlyExpenseId], references: [id], onDelete: Cascade)
  monthlyExpenseId  String?

  @@map("transactions")
}

model Balance {
  id           String   @id @default(ulid())
  member       Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId     String   @unique
  currentMonth Int
  currentYear  Int
  status       String // "open" | "paid"
  prepaid      Decimal  @default(0) @db.Decimal(10, 2) // positive: money paid in advance
  due          Decimal  @default(0) @db.Decimal(10, 2) // positive: money owed for past months
  updatedAt    DateTime @updatedAt

  @@map("member_balances")
}

model Member {
  id                    String             @id @default(ulid())
  tnsNumber             String?            @unique
  alternativePhone      String?
  country               String
  areaOfResidence       String
  state                 String?
  zipCode               String?
  idNumber              String             @unique
  sex                   String
  maritalStatus         MaritalStatus
  emergencyContactName  String?
  emergencyContactPhone String?
  membershipType        MembershipType     @default(basic)
  registrationStatus    ApprovalStatus     @default(pending)
  paymentStatus         TransactionStatus?
  maturityStatus        MaturityStatus? // "propabation" | "matured"
  probationEndDate      DateTime? // end of probation 92days
  mpesaPaymentReference String?
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String             @unique
  files                 MemberFile[]
  documents             MemberDocument[]
  settings              MemberSetting[]
  beneficiaries         Beneficiary[]
  approvals             MemberApproval[]
  parents               Parent[]
  spouses               Spouse[]
  children              Child[]
  transactions          Transaction[]
  balance               Balance[] // FIXED TO 100
  contributions         Contribution[]
  createdAt             DateTime           @default(now()) //This will also handle the exact due date of the member so cron should run everyday at 12 noon and check if the user has finished 1 month then subtract 100 from his account immediadelly
  updatedAt             DateTime           @updatedAt

  @@map("members")
}

model MonthlyExpense {
  id              String               @id @default(ulid())
  amount          Decimal              @default(0) @db.Decimal(10, 2)
  expenseCategory ExpenseCategory
  approvedBy      User?                @relation(fields: [approvedById], references: [id], onDelete: SetNull)
  approvedById    String?
  description     String?              @db.LongText
  status          MonthlyExpenseStatus // paid | pending | cancelled | approved
  expenseDate     DateTime // the actual date of the expense
  transactions    Transaction[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([expenseCategory])
  @@map("monthly_expenses")
}

model Disbursement {
  id                 String                 @id @default(ulid())
  amount             Decimal                @db.Decimal(10, 2)
  reason             String?                @db.Text
  disbursementType   DisbursementType?
  status             DisbursementStatus     @default(pending)
  approvedBy         User?                  @relation(fields: [approvedById], references: [id], onDelete: SetNull)
  approvedById       String?
  bereavementFormUrl String? // optional URL to document
  disbursementDate   DateTime // date when it is/will be disbursed
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  documents          DisbursementDocument[]
  transactions       Transaction[]

  @@index([status])
  @@map("disbursements")
}

model DisbursementDocument {
  id             String       @id @default(ulid())
  disbursementId String
  disbursement   Disbursement @relation(fields: [disbursementId], references: [id], onDelete: Cascade)
  filename       String
  fileType       String
  fileSize       Int
  fileData       String // could be a URL or base64
  uploadedBy     String?
  uploadedAt     DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([disbursementId])
  @@map("disbursement_documents")
}

model MpesaTransaction {
  id                 String       @id @default(ulid())
  transactionId      String       @unique
  phone              String?
  checkoutRequestId  String?
  merchantRequestId  String?
  mpesaReceiptNumber String?
  resultCode         String?
  resultDesc         String?
  transaction        Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  paymentDate        DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@map("mpesa_transactions")
}

model ContactSubmission {
  id        String        @id @default(ulid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    ContactStatus @default(pending)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("contact_submission")
}

model TnsCounter {
  id      Int @id @default(1)
  current Int @default(0)

  @@map("tns_counts")
}

model Parent {
  id              String  @id @default(ulid())
  memberId        String
  name            String?
  phone           String?
  altPhone        String?
  areaOfResidence String?
  idNumber        String?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_parents")
}

model Spouse {
  id              String  @id @default(ulid())
  memberId        String
  name            String?
  phone           String?
  altPhone        String?
  areaOfResidence String?
  sex             String?
  idNumber        String?
  photo           String?
  member          Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_spouses")
}

model Child {
  id               String  @id @default(ulid())
  memberId         String
  name             String
  dob              String
  age              String
  birthCertificate String?
  member           Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_children")
}

model MemberFile {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("member_files")
}

model MemberDocument {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("member_documents")
}

model UserPreference {
  id     String @id @default(ulid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@map("user_preferences")
}

model MemberSetting {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("member_settings")
}

model Beneficiary {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("beneficiaries")
}

model MemberApproval {
  id           String       @id @default(ulid())
  approvalType ApprovalType
  comment      String?      @db.Text
  approver     User?        @relation(fields: [approverId], references: [id], onDelete: SetNull)
  approverId   String?
  member       Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId     String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("member_approvals")
}

model StaffApproval {
  id           String       @id @default(ulid())
  approvalType ApprovalType
  comment      String?
  // who was approved
  user         User         @relation("approved_received", fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  // who approved them
  approver     User?        @relation("approver_given", fields: [approverId], references: [id], onDelete: SetNull)
  approverId   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("staff_approvals")
}

model Task {
  id              String        @id @default(ulid())
  title           String
  description     String?       @db.Text
  data            Json? // optional JSON payload
  assignedArea    String? // optional, for area assignment
  submittedBy     User          @relation(fields: [userId], references: [id])
  submittedToRole String // role responsible for handling
  taskType        TaskType
  priority        TaskPriority? // optional
  status          TaskStatus    @default(pending)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  userId          String

  @@index([assignedArea])
  @@index([submittedToRole])
  @@map("tasks")
}

enum UserRole {
  super_admin
  admin
  user
  member
  advisory_committee
  general_coordinator
  area_coordinator
  secretary
  customer_service_personnel
  organizing_secretary
  treasurer
  auditor
}

enum ApprovalStatus {
  pending
  rejected
  approved
}

enum ApprovalType {
  registration // "pending" | "rejected" | "approved"
  payment
  loan
  withdrawal
  benefit
  penalty
  profile_update
  user_status // "suspension" | "banned" | "active" | "inactive"
  termination
}

enum AccountStatus {
  active
  inactive
  suspended
  banned
}

enum MaritalStatus {
  married
  single
  divorced
  widowed
}

enum ExpenseCategory {
  rent
  utilities
  salaries
  office_supplies
  maintenance
  transportation
  communication
  professional_fees
  insurance
  marketing
  other
}

enum TransactionMenthod {
  mpesa
  cash
  manual_payment
}

enum TransactionType {
  contribution
  disbursement // payout
}

enum TransactionStatus {
  completed
  pending
  failed
}

enum MaturityStatus {
  probation
  matured
}

enum MembershipType {
  basic
  individual
  family
}

enum ContributionTypeCategory {
  monthly_contribution
  case
  project
  registration
  other
}

enum ContributionTypeCategoryStatus {
  active
  pending
  cancelled
  completed
}

enum ContributionStatus {
  paid
  pending
  failed
}

enum ContactStatus {
  pending
  read
  resolved
}

enum DisbursementStatus {
  pending
  approved
  rejected
  cancelled
  paid
}

enum MonthlyExpenseStatus {
  pending
  approved
  rejected
  cancelled
  paid
}

enum DisbursementType {
  regular
  emergency
  bereavement
  other
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum TaskType {
  general
  maintenance
  follow_up
  other
}
