generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(ulid())
  firstName        String
  lastName         String
  email            String           @unique
  phone            String?          @unique
  password         String?
  userRole         UserRole         @default(user)
  requestedRole    UserRole?
  assignedArea     String?
  approval         ApprovalStatus   @default(pending)
  status           AccountStatus    @default(active)
  verificationCode String?
  isVerified       Boolean          @default(false)
  createdAt        DateTime         @default(now())
  sessions         Session[]
  member           Member? //* User can become a member or not
  updatedAt        DateTime         @updatedAt
  photo            String?
  preferences      UserPreference[]
  membersApproved  MemberApproval[]
  tasks            Task[] // submitted

  // approvals this user RECEIVED
  approvalsReceived StaffApproval[] @relation("approved_received")
  // approvals this user GAVE
  approvalsGiven    StaffApproval[] @relation("approver_given")

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(ulid())
  sessionId    String   @db.Text
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  deviceId     String?
  deviceInfo   String?
  ipAddress    String?
  location     String?
  compositeKey String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("user_sessions")
}

model Contribution {
  id               String             @id @default(ulid())
  memberId         String
  member           Member             @relation(fields: [memberId], references: [id])
  amount           Float              @default(0.0)
  contributionType PaymentTypes
  contributionDate DateTime           @default(now())
  month            Int?
  year             Int?
  projectId        String? // only if type = project
  caseId           String? // only if type = cases
  status           ContributionStatus @default(pending)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([memberId])
  @@index([projectId])
  @@index([caseId])
  @@map("contributions")
}

model ContactSubmission {
  id        String        @id @default(ulid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    ContactStatus @default(pending)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("contact_submission")
}

model Disbursement {
  id                 String                 @id @default(ulid())
  memberId           String
  member             Member                 @relation(fields: [memberId], references: [id])
  amount             Float
  reason             String?                @db.Text
  disbursementType   DisbursementType?
  status             DisbursementStatus     @default(pending)
  approvedBy         String? // staff who approved
  bereavementFormUrl String? // optional URL to document
  disbursementDate   DateTime // date when it is/will be disbursed
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  documents          DisbursementDocument[]

  @@index([memberId])
  @@index([status])
  @@map("disbursements")
}

model DisbursementDocument {
  id             String       @id @default(ulid())
  disbursementId String // foreign key to Disbursement table
  disbursement   Disbursement @relation(fields: [disbursementId], references: [id], onDelete: Cascade)
  filename       String
  fileType       String
  fileSize       Int
  fileData       String // could be a URL or base64
  uploadedBy     String?
  uploadedAt     DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([disbursementId])
  @@map("disbursement_documents")
}

model Member {
  id                    String          @id @default(ulid())
  tnsNumber             String?         @unique
  alternativePhone      String?
  country               String
  areaOfResidence       String
  state                 String?
  zipCode               String?
  idNumber              String          @unique
  sex                   String
  maritalStatus         MaritalStatus
  emergencyContactName  String?
  emergencyContactPhone String?
  membershipType        MembershipType  @default(basic)
  registrationStatus    ApprovalStatus  @default(pending)
  paymentStatus         PaymentStatus?
  maturityStatus        MaturityStatus?
  daysToMaturity        Int? // number of days remaining to maturity
  probationEndDate      DateTime? // end of probation
  mpesaPaymentReference String?

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String           @unique
  paymentHistory PaymentHistory[]
  files          MemberFile[]
  documents      MemberDocument[]
  settings       MemberSetting[]
  beneficiaries  Beneficiary[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  approvals      MemberApproval[]
  contributions  Contribution[]
  disbursements  Disbursement[]
  mpesaPayments  MpesaPayment[]
  parents        Parent[]
  spouses        Spouse[]
  children       Child[]

  @@map("members")
}

model TnsCounter {
  id      Int @id @default(1)
  current Int @default(0)

  @@map("tns_counts")
}

model Parent {
  id              String  @id @default(ulid())
  memberId        String
  name            String?
  phone           String?
  altPhone        String?
  areaOfResidence String?
  idNumber        String?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_parents")
}

model Spouse {
  id              String  @id @default(ulid())
  memberId        String
  name            String?
  phone           String?
  altPhone        String?
  areaOfResidence String?
  sex             String?
  idNumber        String?
  photo           String?
  member          Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_spouses")
}

model Child {
  id               String  @id @default(ulid())
  memberId         String
  name             String
  dob              String
  age              String
  birthCertificate String?
  member           Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_children")
}

model PaymentHistory {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("payment_history")
}

model MemberFile {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("member_files")
}

model MemberDocument {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("member_documents")
}

model UserPreference {
  id     String @id @default(ulid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@map("user_preferences")
}

model MemberSetting {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("member_settings")
}

model Beneficiary {
  id       String @id @default(ulid())
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId String

  @@map("beneficiaries")
}

model MonthlyExpense {
  id              String          @id @default(ulid())
  amount          Float
  expenseCategory ExpenseCategory
  description     String?         @db.Text
  approvedBy      String?
  expenseDate     DateTime // the actual date of the expense
  monthYear       String // e.g., "2026-02" for easy reporting
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([expenseCategory])
  @@map("monthly_expenses")
}

model MpesaPayment {
  id                 String             @id @default(ulid())
  memberId           String
  member             Member             @relation(fields: [memberId], references: [id])
  amount             Float
  phoneNumber        String
  checkoutRequestId  String?
  merchantRequestId  String?
  mpesaReceiptNumber String?
  resultCode         String?
  resultDesc         String?
  transactionDate    DateTime?
  status             MpesaPaymentStatus @default(pending)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([memberId])
  @@index([status])
  @@map("mpesa_payments")
}

model MemberBalance {
  id String @id @default(ulid())

  @@map("member_balance")
}

model MemberApproval {
  id           String       @id @default(ulid())
  approvalType ApprovalType
  comment      String?      @db.Text
  approver     User?        @relation(fields: [approverId], references: [id], onDelete: SetNull)
  approverId   String?
  member       Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId     String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("member_approvals")
}

model StaffApproval {
  id           String       @id @default(ulid())
  approvalType ApprovalType
  comment      String?
  // who was approved
  user         User         @relation("approved_received", fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  // who approved them
  approver     User?        @relation("approver_given", fields: [approverId], references: [id], onDelete: SetNull)
  approverId   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("staff_approvals")
}

model Task {
  id              String        @id @default(ulid())
  title           String
  description     String?       @db.Text
  data            Json? // optional JSON payload
  assignedArea    String? // optional, for area assignment
  submittedBy     User          @relation(fields: [userId], references: [id])
  submittedToRole String // role responsible for handling
  taskType        TaskType
  priority        TaskPriority? // optional
  status          TaskStatus    @default(pending)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  userId          String

  @@index([assignedArea])
  @@index([submittedToRole])
  @@map("tasks")
}

enum UserRole {
  super_admin
  admin
  user
  member
  advisory_committee
  general_coordinator
  area_coordinator
  secretary
  customer_service_personnel
  organizing_secretary
  treasurer
  auditor
}

enum ApprovalStatus {
  pending
  rejected
  approved
}

enum ApprovalType {
  registration // "pending" | "rejected" | "approved"
  payment
  loan
  withdrawal
  benefit
  penalty
  profile_update
  user_status // "suspension" | "banned" | "active" | "inactive"
  termination
}

enum AccountStatus {
  active
  inactive
  suspended
  banned
}

enum MaritalStatus {
  married
  single
  divorced
  widowed
}

enum ExpenseCategory {
  utilities
  salaries
  rent
  supplies
  maintenance
  other
}

enum PaymentStatus {
  paid
  pending
}

enum MaturityStatus {
  probation
  matured
}

enum MembershipType {
  basic
  individual
  family
}

enum PaymentTypes {
  monthly_contribution
  cases
  project
  registration
  other
}

enum ContributionStatus {
  paid
  pending
  failed
}

enum ContactStatus {
  pending
  read
  resolved
}

enum DisbursementStatus {
  pending
  approved
  rejected
  paid
}

enum DisbursementType {
  regular
  emergency
  bereavement
  other
}

enum MpesaPaymentStatus {
  pending
  completed
  failed
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum TaskType {
  general
  maintenance
  follow_up
  other
}
